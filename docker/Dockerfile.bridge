# Certainly/Lean4 Bridge container (Lean 4 + Python bridge server)
# - Exposes HTTP bridge on port 8787
# - Runs `python -m lean4_prover.bridge.server --host 0.0.0.0 --port 8787`

FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive \
    TZ=UTC \
    PATH="/root/.elan/bin:${PATH}" \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1

# Base OS deps + Python + build tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates curl git build-essential \
    python3 python3-pip python3-venv \
    && rm -rf /var/lib/apt/lists/*

# Install Lean 4 toolchain via elan (pinned)
RUN curl -sSf https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh \
    | sh -s -- --default-toolchain leanprover/lean4:v4.23.0-rc2 -y

WORKDIR /app

# Copy repo code (expects build context at repo root)
COPY . /app

# Python runtime deps for the FastAPI bridge variant in this repo
RUN python3 -m pip install --upgrade pip && \
    python3 -m pip install uvicorn fastapi pydantic psutil

# Default artifacts dir inside container
ENV CERTAINLY_ARTIFACTS_DIR=/app/local/artifacts/runs
# Lean project lives outside image; default to /lean4 mount provided by compose
ENV LEAN4_REPO=/lean4
ENV PYTHONPATH=/app/src:${PYTHONPATH}

EXPOSE 8787/tcp

CMD ["uvicorn", "src.lean4_prover.bridge.server:app", "--host", "0.0.0.0", "--port", "8787"]
